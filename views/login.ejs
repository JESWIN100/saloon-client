<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OTP Login - Salon System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary-color: #6f42c1;
      --secondary-color: #e83e8c;
      --success-color: #198754;
      --danger-color: #dc3545;
    }
    
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
    }
    
    .card {
      border: none;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
    }
    
    .card-header {
      /* background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); */
      color: black; /* Changed to white for better contrast */
      text-align: center;
      padding: 2rem 1rem;
      border-bottom: none;
    }
    
    .card-body {
      padding: 2.5rem;
    }
    
    .form-control {
      border-radius: 10px;
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      transition: all 0.3s;
    }
    
    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(111, 66, 193, 0.25);
    }
    
    .btn-primary {
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      border: none;
      border-radius: 10px;
      padding: 12px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-primary:hover:not(:disabled) { /* Added not(:disabled) */
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(111, 66, 193, 0.4);
    }

    /* Added disabled styling for primary button */
    .btn-primary:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }
    
    .btn-success {
      border-radius: 10px;
      padding: 12px;
      font-weight: 600;
    }
    
    .otp-input {
      letter-spacing: 10px;
      font-size: 1.5rem;
      font-weight: bold;
      text-align: center;
    }
    
    .timer {
      font-size: 1rem;
      font-weight: 600;
      margin-top: 10px;
    }
    
    .salon-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    
    .step-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
    }
    
    .step {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 10px;
      font-weight: bold;
      color: #6c757d;
      transition: background-color 0.3s, color 0.3s;
    }
    
    .step.active {
      background-color: var(--primary-color);
      color: white;
    }
    
    .step-line {
      flex: 1;
      height: 2px;
      background-color: #e9ecef;
      margin: 0 5px;
      align-self: center;
      transition: background-color 0.3s;
    }
    
    .step-line.active {
      background-color: var(--primary-color);
    }
    
    .message {
      padding: 10px;
      border-radius: 10px;
      margin-top: 15px;
      text-align: center;
      display: none; /* FIX: START HIDDEN, JS WILL SHOW */
    }
    
    .success-message {
      background-color: rgba(25, 135, 84, 0.1);
      color: var(--success-color);
      border: 1px solid rgba(25, 135, 84, 0.2);
    }
    
    .error-message {
      background-color: rgba(220, 53, 69, 0.1);
      color: var(--danger-color);
      border: 1px solid rgba(220, 53, 69, 0.2);
    }
    
    .info-message {
      background-color: rgba(13, 110, 253, 0.1);
      color: #0d6efd;
      border: 1px solid rgba(13, 110, 253, 0.2);
    }
    
    .resend-link {
      cursor: pointer;
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 500;
    }
    
    .resend-link:hover {
      text-decoration: underline;
    }
    
    .resend-link.disabled {
      color: #6c757d;
      cursor: not-allowed;
      text-decoration: none;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .footer {
      text-align: center;
      margin-top: 2rem;
      color: #6c757d;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-6 col-lg-5">
        <div class="card">
          <div class="card-header">
            <div class="salon-icon">
              <i class="fas fa-spa"></i>
            </div>
            <h2 class="mb-0">Go 2 Saloon</h2>
            <p class="mb-0 mt-2">Secure OTP Login</p>
          </div>
          <div class="card-body">
            <div class="step-indicator">
              <div class="step active" id="step-1">1</div>
              <div class="step-line" id="step-line-1"></div>
              <div class="step" id="step-2">2</div>
            </div>
            
            <div id="email-section">
              <h4 class="text-center mb-4">Enter Your Email</h4>
              <div class="mb-4">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" id="email" class="form-control" placeholder="you@example.com" autofocus autocomplete="email" /> <div class="form-text">We'll send a 6-digit OTP to this email</div>
              </div>
              <button id="sendOtpBtn" class="btn btn-primary w-100">
                <span class="btn-text">Send OTP</span>
              </button>
            </div>

            <div id="otp-section" class="d-none">
              <h4 class="text-center mb-4">Enter OTP</h4>
              <div class="mb-4">
                <label for="otp" class="form-label">6-Digit Verification Code</label>
                <input type="text" id="otp" class="form-control otp-input" placeholder="------" maxlength="6" inputmode="numeric" autocomplete="one-time-code" /> 
                <div class="form-text">Enter the code sent to <span id="target-email" class="fw-bold"></span></div>
              </div>
              
              <div id="otp-timer" class="timer text-center text-muted mb-3">
                OTP expires in: <span id="countdown">05:00</span>
              </div>
              
              <button id="verifyOtpBtn" class="btn btn-success w-100 mb-3">
                <span class="btn-text">Verify OTP</span>
              </button>
              
              <div class="text-center">
                <span>Didn't receive the code? </span>
                <a id="resendOtpBtn" class="resend-link disabled">Resend OTP</a> 
              </div>
            </div>

            <div id="message" class="message"></div>
          </div>
          
          <div class="footer p-3">
            <p>Â© 2023 Salon Elegance. All rights reserved.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const emailInput = document.getElementById("email");
    const otpInput = document.getElementById("otp");
    const sendOtpBtn = document.getElementById("sendOtpBtn");
    const verifyOtpBtn = document.getElementById("verifyOtpBtn");
    const resendOtpBtn = document.getElementById("resendOtpBtn");
    const messageDiv = document.getElementById("message");
    const emailSection = document.getElementById("email-section");
    const otpSection = document.getElementById("otp-section");
    const countdownSpan = document.getElementById("countdown");
    const targetEmailSpan = document.getElementById("target-email");

    // Step Indicators
    const step1 = document.getElementById("step-1");
    const step2 = document.getElementById("step-2");
    const stepLine1 = document.getElementById("step-line-1");

    let timerInterval;
    const RESEND_DELAY_SECONDS = 30; // Time before resend is enabled (e.g., 30 seconds)
    const OTP_EXPIRY_SECONDS = 300; // OTP valid for 5 minutes (300 seconds)

    // --- Helper Functions ---

    function showMessage(text, type) {
      messageDiv.textContent = text;
      messageDiv.className = `message ${type}-message`;
      messageDiv.style.display = 'block';
    }

    function toggleLoading(button, isLoading, originalText) {
      button.disabled = isLoading;
      const btnText = button.querySelector(".btn-text");
      
      if (isLoading) {
        btnText.innerHTML = `<span class="loading-spinner"></span>${originalText}...`;
      } else {
        btnText.textContent = originalText;
      }
    }

    function updateStepIndicator(step) {
        if (step === 1) {
            step1.classList.add('active');
            step2.classList.remove('active');
            stepLine1.classList.remove('active');
        } else if (step === 2) {
            step1.classList.remove('active');
            step2.classList.add('active');
            stepLine1.classList.add('active');
        }
    }
    
    function startTimer(duration) {
        let timer = duration;
        let secondsLeft = RESEND_DELAY_SECONDS;
        
        clearInterval(timerInterval);
        resendOtpBtn.classList.add('disabled');
        resendOtpBtn.textContent = `Resend in ${secondsLeft}s`;
        
        timerInterval = setInterval(() => {
            let minutes = parseInt(timer / 60, 10);
            let seconds = parseInt(timer % 60, 10);

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            countdownSpan.textContent = `${minutes}:${seconds}`;

            // Handle Resend Delay
            if (secondsLeft > 0) {
                secondsLeft--;
                resendOtpBtn.textContent = `Resend in ${secondsLeft}s`;
            } else if (secondsLeft === 0) {
                resendOtpBtn.textContent = "Resend OTP";
                resendOtpBtn.classList.remove('disabled');
                secondsLeft = -1; // Stop counting down the secondsLeft
            }

            // Handle Expiry
            if (--timer < 0) {
                clearInterval(timerInterval);
                countdownSpan.textContent = "EXPIRED";
                resendOtpBtn.classList.remove('disabled');
                showMessage("Your OTP has expired. Please resend the code.", "error");
                verifyOtpBtn.disabled = true;
            }
        }, 1000);
    }
    
    // --- Event Handlers ---

    async function handleSendOtp() {
        const email = emailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        messageDiv.style.display = 'none'; // Clear previous messages
        verifyOtpBtn.disabled = false;

        if (!email || !emailRegex.test(email)) {
            showMessage("Please enter a valid email address.", "error");
            return;
        }

        toggleLoading(sendOtpBtn, true, "Sending OTP");

        try {
            const res = await fetch("/auth/send-otp", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email }),
            });

            const data = await res.json();
            
            if (res.ok) {
                showMessage(`OTP sent to ${email}.`, "success");
                targetEmailSpan.textContent = email;
                emailSection.classList.add("d-none");
                otpSection.classList.remove("d-none");
                updateStepIndicator(2);
                startTimer(OTP_EXPIRY_SECONDS);
                otpInput.focus();
            } else {
                showMessage(data.message || "An error occurred while sending OTP.", "error");
            }
        } catch (error) {
            console.error("Fetch error:", error);
            showMessage("Network error. Please try again.", "error");
        } finally {
            toggleLoading(sendOtpBtn, false, "Send OTP");
        }
    }

    async function handleVerifyOtp() {
        const email = emailInput.value.trim();
        const otp = otpInput.value.trim();
        
        messageDiv.style.display = 'none';

        if (otp.length !== 6 || isNaN(otp)) {
             showMessage("Please enter a valid 6-digit code.", "error");
             return;
        }

        toggleLoading(verifyOtpBtn, true, "Verifying");

        try {
            const res = await fetch("/auth/verify-otp", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, otp }),
            });

            const data = await res.json();
            
            if (res.ok) {
                showMessage("Login Successful! Redirecting...", "success");
                clearInterval(timerInterval);
                // Simulate a slight delay before redirecting for the user to see the success message
                setTimeout(() => {
                    window.location.href = '/home'; 
                }, 1000);
            } else {
                showMessage(data.message || "OTP verification failed. Check the code and try again.", "error");
            }
        } catch (error) {
            console.error("Fetch error:", error);
            showMessage("Network error during verification. Please try again.", "error");
        } finally {
            toggleLoading(verifyOtpBtn, false, "Verify OTP");
        }
    }

    function handleResendOtpClick() {
        if (!resendOtpBtn.classList.contains('disabled')) {
             // Reset form fields and attempt to re-send OTP
             otpInput.value = '';
             handleSendOtp(); // Re-use the existing send function
        }
    }

    sendOtpBtn.addEventListener("click", handleSendOtp);
    verifyOtpBtn.addEventListener("click", handleVerifyOtp);
    // FIX: Changed behavior to re-send instead of just switching back
    resendOtpBtn.addEventListener("click", handleResendOtpClick); 
    
    // Allow 'Enter' key to trigger Send/Verify
    emailInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleSendOtp();
    });
    otpInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleVerifyOtp();
    });

    // Optional: Auto-focus the next step when OTP is complete
    otpInput.addEventListener('input', () => {
        if (otpInput.value.length === 6) {
            handleVerifyOtp();
        }
    });

  </script>
</body>
</html>